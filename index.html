<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENIGMA - Personnalisation temps r√©el</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ENIGMA">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { height: 100vh; overflow: hidden; color: white; }

        @keyframes soulignement { 0% { width: 0; opacity: 0; } 50% { width: 100%; opacity: 1; } 100% { width: 100%; opacity: 0.7; } }
        @keyframes scintillement { 0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700; } 50% { text-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700, 0 0 40px #FFD700; } 100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700; } }
        @keyframes apparitionBouton { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes ripple { 0% { transform: scale(0, 0) translate(-50%, -50%); opacity: 0.5; } 100% { transform: scale(20, 20) translate(-50%, -50%); opacity: 0; } }
        @keyframes circleWave { 0% { opacity: 0.9; transform: scale(0.5); } 70% { opacity: 0.5; transform: scale(1.3); } 100% { opacity: 0; transform: scale(1.6); } }
        
        @keyframes auraPulse {
            0% { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor, 0 0 15px currentColor; }
            50% { text-shadow: 0 0 20px currentColor, 0 0 30px currentColor, 0 0 40px currentColor; }
            100% { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor, 0 0 15px currentColor; }
        }

        .app-title { font-family: 'Georgia', 'Times New Roman', serif; font-size: 68px; font-weight: bold; color: #FFD700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.7), 0 0 30px rgba(255, 215, 0, 0.4); letter-spacing: 6px; margin-bottom: 100px; position: relative; top: -40px; text-transform: uppercase; padding-bottom: 15px; animation: scintillement 2s ease-in-out infinite; }
        .app-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 3px; background: #FFD700; box-shadow: 0 0 10px #FFD700; animation: soulignement 1.5s ease-out forwards; }

        .home-btn { width: 320px; height: 65px; background: white; color: black; border: none; border-radius: 15px; font-size: 24px; font-weight: 600; letter-spacing: 1px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2); transition: transform 0.2s, box-shadow 0.2s, background 0.2s; position: relative; overflow: hidden; margin: 12px 0; opacity: 0; transform: translateY(30px); animation: apparitionBouton 0.5s ease-out forwards; }
        #btn-perform { animation-delay: 0.2s; } #btn-list { animation-delay: 0.4s; } #btn-settings { animation-delay: 0.6s; }
        .home-btn::after { content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: rgba(0, 0, 0, 0.3); opacity: 0; border-radius: 100%; transform: scale(1, 1) translate(-50%, -50%); transform-origin: 50% 50%; }
        .home-btn:active { transform: scale(0.95); box-shadow: 0 2px 10px rgba(255, 255, 255, 0.4); background: #f0f0f0; }
        .home-btn:active::after { animation: ripple 0.4s ease-out; }

        #home-page { position: absolute; inset: 0; background: black; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 15vh; z-index: 20; transition: transform 0.3s ease-out; }
        #home-page.hidden { transform: translateY(-100%); }

        #settings-page { position: absolute; inset: 0; background: black; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 25; visibility: hidden; opacity: 0; transition: visibility 0.3s, opacity 0.3s; padding: 20px; }
        #settings-page.visible { visibility: visible; opacity: 1; }

        .settings-title { font-size: 48px; color: #FFD700; margin-bottom: 50px; font-weight: bold; text-transform: uppercase; letter-spacing: 4px; }
        .settings-btn { width: 320px; height: 65px; background: #333; color: white; border: none; border-radius: 15px; font-size: 22px; font-weight: 600; cursor: pointer; margin: 10px 0; transition: background 0.2s; }
        .settings-btn:active { background: #555; }

        .preview-container { width: 320px; margin: 20px 0; display: none; flex-direction: column; align-items: center; }        .preview-container.visible { display: flex; }
        .preview-image { width: 200px; height: 200px; object-fit: cover; border-radius: 15px; border: 3px solid #FFD700; margin-bottom: 15px; }
        .preview-buttons { display: flex; gap: 20px; }
        .preview-confirm, .preview-cancel { width: 120px; height: 50px; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; }
        .preview-confirm { background: #4CAF50; color: white; }
        .preview-cancel { background: #f44336; color: white; }
        .back-btn { width: 320px; height: 50px; background: #666; color: white; border: none; border-radius: 10px; font-size: 18px; cursor: pointer; margin-top: 30px; }
        .back-btn:active { background: #888; }

        #customize-page { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 40; visibility: hidden; opacity: 0; transition: visibility 0.3s, opacity 0.3s; overflow-y: auto; padding: 20px; color: white; }
        #customize-page.visible { visibility: visible; opacity: 1; }
        
        #customize-note-page { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 70; visibility: hidden; opacity: 0; transition: visibility 0.3s, opacity 0.3s; overflow-y: auto; padding: 20px; color: white; }
        #customize-note-page.visible { visibility: visible; opacity: 1; }
        
        #customize-page.dragging-slider, #customize-note-page.dragging-slider { background: transparent !important; pointer-events: none; }
        #customize-page.dragging-slider .control-group, #customize-page.dragging-slider .test-code-section, #customize-page.dragging-slider .customize-header, #customize-page.dragging-slider .customize-actions,
        #customize-note-page.dragging-slider .control-group, #customize-note-page.dragging-slider .customize-header, #customize-note-page.dragging-slider .customize-actions { opacity: 0 !important; pointer-events: none; }
        #customize-page.dragging-slider input[type="range"], #customize-note-page.dragging-slider input[type="range"] { opacity: 1 !important; position: relative; z-index: 9999; pointer-events: auto; }
        #customize-page.dragging-slider .value-badge, #customize-note-page.dragging-slider .value-badge { opacity: 1 !important; position: relative; z-index: 9999; pointer-events: auto; cursor: pointer; background: #FFD700; color: black; font-weight: bold; }
        #customize-page.dragging-slider .slider-item, #customize-note-page.dragging-slider .slider-item { position: relative; z-index: 9999; }
        #customize-page.dragging-slider .slider-item label, #customize-note-page.dragging-slider .slider-item label { opacity: 0 !important; }
        
        #result-page.preview-mode { visibility: visible !important; opacity: 1 !important; z-index: 35; pointer-events: none; }
        #customize-note-page.preview-mode { background: rgba(0, 0, 0, 0.85); }

        .customize-header { display: flex; align-items: center; margin-bottom: 30px; padding-top: 20px; }
        .customize-back-btn { width: 40px; height: 40px; background: #333; border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; margin-right: 15px; }
        .customize-back-btn:active { background: #555; }
        .customize-title { font-size: 32px; color: #FFD700; font-weight: bold; }

        .test-code-section { background: #222; border-radius: 15px; padding: 20px; margin-bottom: 25px; border: 1px solid #444; text-align: center; }
        .test-code-title { color: #FFD700; font-size: 22px; margin-bottom: 15px; }
        #test-code-input { width: 200px; height: 55px; background: #333; border: 2px solid #444; border-radius: 15px; color: white; font-size: 18px; text-align: center; letter-spacing: 4px; }
        #test-code-input:focus { border-color: #FFD700; outline: none; }

        .control-group { background: #222; border-radius: 15px; padding: 20px; margin-bottom: 25px; border: 1px solid #444; }
        .control-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .control-header h3 { color: #FFD700; font-size: 22px; margin: 0; }
        .preview-btn { background: #333; color: white; border: 1px solid #FFD700; border-radius: 20px; padding: 5px 15px; font-size: 14px; cursor: pointer; }
        .slider-item { margin-bottom: 20px; }
        .slider-item label { display: flex; justify-content: space-between; margin-bottom: 8px; color: #ddd; }
        
        .slider-item input[type="range"] {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            -webkit-appearance: none;
            pointer-events: none;        }
        
        .slider-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            pointer-events: auto;
        }
        
        .slider-item input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            pointer-events: auto;
        }
        
        .color-item { margin-bottom: 20px; }
        .color-item label { display: block; margin-bottom: 8px; color: #ddd; }
        .color-item input[type="color"] { width: 100%; height: 45px; border: 2px solid #444; border-radius: 10px; background: #333; }
        .value-badge { background: #333; padding: 3px 10px; border-radius: 15px; font-size: 14px; color: #FFD700; border: 1px solid #FFD700; cursor: pointer; }
        .value-badge:active { background: #444; }

        .customize-actions { display: flex; gap: 15px; margin-top: 30px; margin-bottom: 30px; }
        .customize-save { flex: 1.2; height: 55px; background: #4CAF50; border: none; border-radius: 15px; color: white; font-size: 20px; font-weight: 600; cursor: pointer; }
        .customize-reset { flex: 1; height: 55px; background: #f44336; border: none; border-radius: 15px; color: white; font-size: 18px; font-weight: 600; cursor: pointer; }

        #lock-page {
            position: absolute;
            inset: 0;
            z-index: 10;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: #1a1a1a;
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }
        
        #result-page {            position: absolute;
            inset: 0;
            z-index: 30;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
            background: #2a2a2a;
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        #lock-page.visible { visibility: visible; opacity: 1; }
        #result-page.visible { visibility: visible; opacity: 1; }
        
        .overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.3); }
        .lock-content { position: relative; z-index: 10; text-align: center; margin-bottom: 5vh; padding: 0 16px; }
        .pin-dots { display: flex; justify-content: center; gap: 16px; margin-bottom: 3vh; }
        .dot { width: 14px; height: 14px; border-radius: 50%; background: white; opacity: 0.35; transition: opacity 0.2s, transform 0.2s; }
        .dot.active { opacity: 1; transform: scale(1.25); }
        .keypad { display: grid; grid-template-columns: repeat(3, 70px); justify-content: center; gap: 20px 25px; margin-bottom: 15px; }
        .key { width: 70px; height: 70px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(12px); cursor: pointer; border: 1px solid rgba(255,255,255,0.1); color: white; }
        .key-number { font-size: 28px; font-weight: 500; }
        .key-letters { font-size: 10px; color: rgba(255, 255, 255, 0.6); margin-top: 2px; }
        .key:active { background: rgba(255, 255, 255, 0.35); transform: scale(0.97); }
        .key::after { content: ''; position: absolute; inset: 0; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.9); opacity: 0; pointer-events: none; }
        .active::after, .active-text::after { animation: circleWave 0.4s ease-out forwards; }

        .bottom-row { display: grid; grid-template-columns: repeat(3, 70px); justify-content: center; gap: 25px; margin-top: 10px; }
        .delete-btn, .ok { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; background: transparent; cursor: pointer; border: none; color: white; }
        .delete-btn { font-size: 34px; }
        .ok { font-size: 24px; font-weight: 600; }
        .delete-btn:active, .ok:active { opacity: 0.7; transform: scale(0.95); }

        .emergency { text-align: center; margin-bottom: 3vh; font-size: 18px; opacity: 0.9; cursor: pointer; padding: 12px 24px; border-radius: 40px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.15); width: fit-content; margin-left: auto; margin-right: auto; }
        .emergency:active { background: rgba(220, 60, 60, 0.5); }

        .words-container { position: absolute; top: 265px; width: 100%; z-index: 32; color: white; font-size: 18px; text-align: center; }
        .words-container.hidden { display: none; }
        .words-line { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 0 20px; }
        .result-word { cursor: pointer; }
        .letters-container { position: absolute; top: 460px; width: 100%; text-align: center; color: white; font-size: 20px; z-index: 32; padding: 0 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; }
        .letters-container.hidden { display: none; }
        .letter-btn { cursor: pointer; text-transform: uppercase; }
        .letter-btn.selected { text-decoration: underline; }
                .index-display {
            position: absolute;
            top: 517px;
            left: 50%;
            transform: translateX(calc(-50% - 45px));
            color: #1E6FF0;
            font-size: 30px;
            font-weight: bold;
            z-index: 33;
            cursor: pointer;
            transition: text-shadow 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .index-display.note-mode-active {
            animation: auraPulse 1.5s ease-in-out infinite;
        }

        #note-page {
            position: absolute;
            inset: 0;
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #note-page.visible {
            visibility: visible;
            opacity: 1;
        }
        
        .note-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 51;
        }
        
        .note-text {
            position: relative;            z-index: 52;
            color: white;
            font-size: 40px;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            padding: 20px;
            max-width: 90%;
            word-wrap: break-word;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        #list-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 380px; background: white; border-radius: 30px; padding: 25px; z-index: 100; display: none; color: black; box-shadow: 0 20px 40px rgba(0,0,0,0.4); transition: top 0.3s ease-out, transform 0.3s ease-out; }
        #list-modal.visible { display: block; }
        #list-modal.keyboard-open { top: 30px; transform: translate(-50%, 0); }
        #search-input { width: 100%; padding: 18px; border: 2px solid #ddd; border-radius: 15px; font-size: 18px; height: 60px; box-sizing: border-box; margin-bottom: 15px; }
        .code-result-box { width: 100%; padding: 18px; border: 2px solid #1976d2; border-radius: 15px; font-size: 20px; text-align: center; background: #e3f2fd; color: #1976d2; font-weight: bold; min-height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .code-result-box.error { background: #ffebee; border-color: #f44336; color: #f44336; }
        #search-btn { width: 100%; padding: 18px; background: #4CAF50; color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 20px; font-weight: 600; }
        #search-btn.disabled { background: #999; opacity: 0.6; pointer-events: none; }
        #modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 90; display: none; }
        #modal-overlay.visible { display: block; }
        .hidden-file-input { display: none; }
    </style>
</head>
<body>
    <input type="file" id="bg-file-input" class="hidden-file-input" accept="image/*">
    <input type="file" id="img-file-input" class="hidden-file-input" accept="image/*">
    <input type="file" id="note-file-input" class="hidden-file-input" accept="image/*">

    <div id="home-page">
        <div class="app-title">ENIGMA</div>
        <button class="home-btn" id="btn-perform">PERFORMER</button>
        <button class="home-btn" id="btn-list">LISTE DES MOTS</button>
        <button class="home-btn" id="btn-settings">PARAMETRES</button>
    </div>

    <div id="settings-page">
        <div class="settings-title">PARAM√àTRES</div>
        <button class="settings-btn" id="import-bg-btn">üì∑ Importer lock screen</button>
        <button class="settings-btn" id="import-img-btn">üì∑ Importer background</button>
        <button class="settings-btn" id="import-note-btn">üì∑ Importer note</button>
        <!-- ‚úÖ CORRECTION 2 : Ordre invers√© -->
        <button class="settings-btn" id="customize-btn">üé® Modifier background</button>
        <button class="settings-btn" id="modify-note-btn">üé® Modifier note</button>
        <div class="preview-container" id="preview-container">
            <img class="preview-image" id="preview-image" src="" alt="Aper√ßu">            <div class="preview-buttons">
                <button class="preview-confirm" id="preview-confirm">Confirmer</button>
                <button class="preview-cancel" id="preview-cancel">Annuler</button>
            </div>
        </div>
        <button class="back-btn" id="settings-back">‚Üê Retour</button>
    </div>

    <div id="customize-page">
        <div class="customize-header">
            <button class="customize-back-btn" id="customize-back">‚Üê</button>
            <span class="customize-title">PERSONNALISER</span>
        </div>
        <div class="test-code-section">
            <div class="test-code-title">üéØ TESTER UN CODE</div>
            <input type="tel" id="test-code-input" placeholder="Code" maxlength="4">
        </div>
        <div class="control-group">
            <div class="control-header">
                <h3>üìã Liste</h3>
                <button class="preview-btn" id="preview-list-btn">üëÅÔ∏è</button>
            </div>
            <div class="slider-item">
                <label>Position Y <span class="value-badge" id="words-y-value">265px</span></label>
                <input type="range" id="words-y" min="0" max="800" value="265">
            </div>
            <div class="slider-item">
                <label>Taille <span class="value-badge" id="words-size-value">18px</span></label>
                <input type="range" id="words-size" min="10" max="40" value="18">
            </div>
            <div class="color-item">
                <label>Couleur</label>
                <input type="color" id="words-color" value="#ffffff">
            </div>
            <div class="slider-item">
                <label>Espace lignes <span class="value-badge" id="words-line-height-value">15px</span></label>
                <input type="range" id="words-line-height" min="5" max="30" value="15">
            </div>
        </div>
        <div class="control-group">
            <div class="control-header">
                <h3>üî§ Lettres</h3>
                <button class="preview-btn" id="preview-letters-btn">üëÅÔ∏è</button>
            </div>
            <div class="slider-item">
                <label>Position Y <span class="value-badge" id="letters-y-value">460px</span></label>
                <input type="range" id="letters-y" min="0" max="800" value="460">
            </div>
            <div class="slider-item">
                <label>Taille <span class="value-badge" id="letters-size-value">20px</span></label>                <input type="range" id="letters-size" min="10" max="40" value="20">
            </div>
            <div class="color-item">
                <label>Couleur</label>
                <input type="color" id="letters-color" value="#ffffff">
            </div>
            <div class="slider-item">
                <label>Espace lettres <span class="value-badge" id="letters-spacing-value">40px</span></label>
                <input type="range" id="letters-spacing" min="0" max="100" value="40">
            </div>
        </div>
        <div class="control-group">
            <div class="control-header">
                <h3>üî¢ Indice</h3>
                <button class="preview-btn" id="preview-index-btn">üëÅÔ∏è</button>
            </div>
            <div class="slider-item">
                <label>Position Y <span class="value-badge" id="index-y-value">517px</span></label>
                <input type="range" id="index-y" min="0" max="800" value="517">
            </div>
            <div class="slider-item">
                <label>Taille <span class="value-badge" id="index-size-value">30px</span></label>
                <input type="range" id="index-size" min="10" max="60" value="30">
            </div>
            <div class="color-item">
                <label>Couleur</label>
                <input type="color" id="index-color" value="#1E6FF0">
            </div>
            <div class="slider-item">
                <label>D√©calage X <span class="value-badge" id="index-x-value">-45px</span></label>
                <input type="range" id="index-x" min="-500" max="500" value="-45">
            </div>
        </div>
        <div class="customize-actions">
            <button class="customize-save" id="customize-save">üíæ Sauvegarder</button>
            <button class="customize-reset" id="customize-reset">‚Ü∫ Reset</button>
        </div>
    </div>

    <!-- PAGE DE PERSONNALISATION POUR NOTE -->
    <div id="customize-note-page">
        <div class="customize-header">
            <button class="customize-back-btn" id="customize-note-back">‚Üê</button>
            <span class="customize-title">PERSONNALISER NOTE</span>
        </div>
        
        <!-- Les 10 mots affich√©s sur l'image de fond -->
        <div class="note-words-container" id="note-words-container" style="position: absolute; top: 262px; left: 50%; transform: translateX(-50%); z-index: 55; color: white; font-size: 18px; text-align: left; line-height: 15px; padding: 20px; max-width: 80%;">
            <div class="note-word-item">Barbecue</div>
            <div class="note-word-item">Iceberg</div>            <div class="note-word-item">Cartouche</div>
            <div class="note-word-item">Yaourt</div>
            <div class="note-word-item">Cartable</div>
            <div class="note-word-item">Livre</div>
            <div class="note-word-item">Enveloppe</div>
            <div class="note-word-item">Tapis</div>
            <div class="note-word-item">Train</div>
            <div class="note-word-item">Encre</div>
        </div>
        
        <div class="control-group" style="position: relative; z-index: 60;">
            <div class="control-header">
                <!-- ‚úÖ CORRECTION 4 : Titre chang√© de "Texte de la Note" √† "Note" -->
                <h3>üìù Note</h3>
                <!-- ‚úÖ CORRECTION 3 : Bouton "üëÅÔ∏è Aper√ßu" ‚Üí "üëÅÔ∏è" -->
                <button class="preview-btn" id="preview-note-btn">üëÅÔ∏è</button>
            </div>
            
            <div class="slider-item">
                <label>Position X <span class="value-badge" id="note-x-value">0px</span></label>
                <input type="range" id="note-x" min="-500" max="500" value="0">
            </div>
            
            <div class="slider-item">
                <label>Position Y <span class="value-badge" id="note-y-value">262px</span></label>
                <input type="range" id="note-y" min="0" max="800" value="262">
            </div>
            
            <div class="slider-item">
                <label>Taille <span class="value-badge" id="note-size-value">18px</span></label>
                <input type="range" id="note-size" min="10" max="40" value="18">
            </div>
            
            <div class="color-item">
                <label>Couleur</label>
                <input type="color" id="note-color" value="#ffffff">
            </div>
            
            <div class="slider-item">
                <label>Espace lignes <span class="value-badge" id="note-line-height-value">15px</span></label>
                <input type="range" id="note-line-height" min="5" max="30" value="15">
            </div>
        </div>
        
        <div class="customize-actions" style="position: relative; z-index: 60;">
            <button class="customize-save" id="customize-note-save">üíæ Sauvegarder</button>
            <button class="customize-reset" id="customize-note-reset">‚Ü∫ Reset</button>
        </div>
    </div>
    <div id="lock-page">
        <div class="overlay"></div>
        <div class="lock-content">
            <div class="pin-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <div class="keypad">
                <div class="key"><span class="key-number">1</span></div>
                <div class="key"><span class="key-number">2</span><span class="key-letters">ABC</span></div>
                <div class="key"><span class="key-number">3</span><span class="key-letters">DEF</span></div>
                <div class="key"><span class="key-number">4</span><span class="key-letters">GHI</span></div>
                <div class="key"><span class="key-number">5</span><span class="key-letters">JKL</span></div>
                <div class="key"><span class="key-number">6</span><span class="key-letters">MNO</span></div>
                <div class="key"><span class="key-number">7</span><span class="key-letters">PQRS</span></div>
                <div class="key"><span class="key-number">8</span><span class="key-letters">TUV</span></div>
                <div class="key"><span class="key-number">9</span><span class="key-letters">WXYZ</span></div>
            </div>
            <div class="bottom-row">
                <div class="delete-btn" id="deleteBtn">‚å´</div>
                <div class="key"><span class="key-number">0</span></div>
                <div class="ok" id="okBtn">OK</div>
            </div>
        </div>
        <div class="emergency" id="emergencyBtn">üìû Appel d'urgence</div>
    </div>

    <div id="result-page">
        <div class="words-container" id="words-container"></div>
        <div class="letters-container" id="letters-container"></div>
        <div class="index-display" id="index-display"></div>
    </div>

    <div id="note-page">
        <div class="note-overlay"></div>
        <div class="note-text" id="note-text"></div>
    </div>

    <div id="modal-overlay"></div>
    <div id="list-modal">
        <input type="text" id="search-input" placeholder="Taper un mot">
        <div class="code-result-box" id="codeResult"></div>
        <button id="search-btn">Rechercher</button>
    </div>

    <script>
(function() {
    const homePage = document.getElementById('home-page');
    const settingsPage = document.getElementById('settings-page');
    const customizePage = document.getElementById('customize-page');
    const customizeNotePage = document.getElementById('customize-note-page');    const lockPage = document.getElementById('lock-page');
    const resultPage = document.getElementById('result-page');
    const noteWordsContainer = document.getElementById('note-words-container');
    const notePage = document.getElementById('note-page');
    const noteText = document.getElementById('note-text');
    const wordsContainer = document.getElementById('words-container');
    const lettersContainer = document.getElementById('letters-container');
    const indexDisplay = document.getElementById('index-display');
    const btnPerform = document.getElementById('btn-perform');
    const btnList = document.getElementById('btn-list');
    const btnSettings = document.getElementById('btn-settings');
    const importBgBtn = document.getElementById('import-bg-btn');
    const importImgBtn = document.getElementById('import-img-btn');
    const importNoteBtn = document.getElementById('import-note-btn');
    const modifyNoteBtn = document.getElementById('modify-note-btn');
    const customizeBtn = document.getElementById('customize-btn');
    const settingsBack = document.getElementById('settings-back');
    const customizeBack = document.getElementById('customize-back');
    const customizeNoteBack = document.getElementById('customize-note-back');
    const customizeSave = document.getElementById('customize-save');
    const customizeReset = document.getElementById('customize-reset');
    const customizeNoteSave = document.getElementById('customize-note-save');
    const customizeNoteReset = document.getElementById('customize-note-reset');
    const previewListBtn = document.getElementById('preview-list-btn');
    const previewLettersBtn = document.getElementById('preview-letters-btn');
    const previewIndexBtn = document.getElementById('preview-index-btn');
    const previewNoteBtn = document.getElementById('preview-note-btn');
    const testCodeInput = document.getElementById('test-code-input');
    const wordsY = document.getElementById('words-y');
    const wordsSize = document.getElementById('words-size');
    const wordsColor = document.getElementById('words-color');
    const wordsLineHeight = document.getElementById('words-line-height');
    const lettersY = document.getElementById('letters-y');
    const lettersSize = document.getElementById('letters-size');
    const lettersColor = document.getElementById('letters-color');
    const lettersSpacing = document.getElementById('letters-spacing');
    const indexY = document.getElementById('index-y');
    const indexSize = document.getElementById('index-size');
    const indexColor = document.getElementById('index-color');
    const indexX = document.getElementById('index-x');
    const noteX = document.getElementById('note-x');
    const noteY = document.getElementById('note-y');
    const noteSize = document.getElementById('note-size');
    const noteColor = document.getElementById('note-color');
    const noteLineHeight = document.getElementById('note-line-height');
    const wordsYValue = document.getElementById('words-y-value');
    const wordsSizeValue = document.getElementById('words-size-value');
    const wordsLineHeightValue = document.getElementById('words-line-height-value');
    const lettersYValue = document.getElementById('letters-y-value');
    const lettersSizeValue = document.getElementById('letters-size-value');    const lettersSpacingValue = document.getElementById('letters-spacing-value');
    const indexYValue = document.getElementById('index-y-value');
    const indexSizeValue = document.getElementById('index-size-value');
    const indexXValue = document.getElementById('index-x-value');
    const noteXValue = document.getElementById('note-x-value');
    const noteYValue = document.getElementById('note-y-value');
    const noteSizeValue = document.getElementById('note-size-value');
    const noteLineHeightValue = document.getElementById('note-line-height-value');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const codeResult = document.getElementById('codeResult');
    const modal = document.getElementById('list-modal');
    const modalOverlay = document.getElementById('modal-overlay');
    const bgFileInput = document.getElementById('bg-file-input');
    const imgFileInput = document.getElementById('img-file-input');
    const noteFileInput = document.getElementById('note-file-input');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    const previewConfirm = document.getElementById('preview-confirm');
    const previewCancel = document.getElementById('preview-cancel');
    const keys = document.querySelectorAll('#lock-page .key');
    const dots = document.querySelectorAll('#lock-page .dot');
    const deleteBtn = document.getElementById('deleteBtn');
    const okBtn = document.getElementById('okBtn');
    const emergencyBtn = document.getElementById('emergencyBtn');

    const wordsList = [
        { code: "7131", word: "Abeille" }, { code: "7141", word: "Abricot" }, { code: "9141", word: "Accord√©on" },
        { code: "6131", word: "Agenda" }, { code: "6141", word: "Agneau" }, { code: "5121", word: "Aigle" },
        { code: "8121", word: "Aiguille" }, { code: "3121", word: "Ail" }, { code: "4121", word: "Aile" }
    ];

    const defaultSettings = {
        wordsY: 265, wordsSize: 18, wordsColor: '#ffffff', wordsLineHeight: 15,
        lettersY: 460, lettersSize: 20, lettersColor: '#ffffff', lettersSpacing: 40,
        indexY: 517, indexSize: 30, indexColor: '#1E6FF0', indexX: -45
    };

    const defaultNoteSettings = {
        noteX: 0,
        noteY: 262,
        noteSize: 18,
        noteColor: '#ffffff',
        noteLineHeight: 15
    };

    let pin = '', currentCode = '', originalWords = [], currentWords = [];
    let letterLists = [], bestListIndex = -1, bestListLetters = [];
    let selectedLetter = '', lastTap = 0, isPreviewMode = false;
    let isSearchDisabled = false, keyboardVisible = false;    let resizeTimeout, blurTimeout, currentPreviewTarget = '', currentPreviewData = '';
    let currentSettings = { ...defaultSettings };
    let currentNoteSettings = { ...defaultNoteSettings };
    let noteModeActive = false;
    let noteLastTap = 0;
    let indexClickCount = 0;
    let indexClickTimer = null;

    window.addEventListener('resize', function() {
        if (window.innerHeight < window.screen.height - 200) {
            keyboardVisible = true;
            modal.classList.add('keyboard-open');
        } else {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (document.activeElement !== searchInput) {
                    keyboardVisible = false;
                    modal.classList.remove('keyboard-open');
                }
            }, 300);
        }
    });

    searchInput.addEventListener('focus', function() { keyboardVisible = true; modal.classList.add('keyboard-open'); });
    searchInput.addEventListener('blur', function() {
        clearTimeout(blurTimeout);
        blurTimeout = setTimeout(() => { keyboardVisible = false; modal.classList.remove('keyboard-open'); }, 300);
    });

    function searchWord(word) {
        const normalized = word.trim().toLowerCase();
        for (let i = 0; i < wordsList.length; i++) {
            if (wordsList[i].word.toLowerCase() === normalized) return wordsList[i];
        }
        return null;
    }

    function enableSearchButton() { searchBtn.classList.remove('disabled'); isSearchDisabled = false; codeResult.textContent = ''; codeResult.classList.remove('error'); }
    function disableSearchButton() { searchBtn.classList.add('disabled'); isSearchDisabled = true; }

    function loadCustomSettings() {
        try { const saved = localStorage.getItem('customSettings'); if (saved) return JSON.parse(saved); } catch(e) {}
        return { ...defaultSettings };
    }

    function saveCustomSettings(settings) { try { localStorage.setItem('customSettings', JSON.stringify(settings)); } catch(e) {} }

    function loadNoteSettings() {
        try { const saved = localStorage.getItem('noteSettings'); if (saved) return JSON.parse(saved); } catch(e) {}
        return { ...defaultNoteSettings };    }

    function saveNoteSettings(settings) { try { localStorage.setItem('noteSettings', JSON.stringify(settings)); } catch(e) {} }

    function applyCustomSettings(settings) {
        wordsContainer.style.top = settings.wordsY + 'px';
        wordsContainer.style.fontSize = settings.wordsSize + 'px';
        wordsContainer.style.color = settings.wordsColor;
        wordsContainer.style.lineHeight = settings.wordsLineHeight + 'px';
        lettersContainer.style.top = settings.lettersY + 'px';
        lettersContainer.style.fontSize = settings.lettersSize + 'px';
        lettersContainer.style.color = settings.lettersColor;
        lettersContainer.style.gap = settings.lettersSpacing + 'px';
        indexDisplay.style.top = settings.indexY + 'px';
        indexDisplay.style.fontSize = settings.indexSize + 'px';
        indexDisplay.style.color = settings.indexColor;
        indexDisplay.style.transform = 'translateX(calc(-50% + ' + settings.indexX + 'px))';
        
        wordsYValue.textContent = settings.wordsY + 'px';
        wordsSizeValue.textContent = settings.wordsSize + 'px';
        wordsLineHeightValue.textContent = settings.wordsLineHeight + 'px';
        lettersYValue.textContent = settings.lettersY + 'px';
        lettersSizeValue.textContent = settings.lettersSize + 'px';
        lettersSpacingValue.textContent = settings.lettersSpacing + 'px';
        indexYValue.textContent = settings.indexY + 'px';
        indexSizeValue.textContent = settings.indexSize + 'px';
        indexXValue.textContent = settings.indexX + 'px';
        
        wordsY.value = settings.wordsY; wordsSize.value = settings.wordsSize; wordsColor.value = settings.wordsColor;
        wordsLineHeight.value = settings.wordsLineHeight; lettersY.value = settings.lettersY;
        lettersSize.value = settings.lettersSize; lettersColor.value = settings.lettersColor;
        lettersSpacing.value = settings.lettersSpacing; indexY.value = settings.indexY;
        indexSize.value = settings.indexSize; indexColor.value = settings.indexColor;
        indexX.value = settings.indexX;
    }

    function applyNoteSettings(settings) {
        noteWordsContainer.style.transform = 'translateX(calc(-50% + ' + settings.noteX + 'px))';
        noteWordsContainer.style.top = settings.noteY + 'px';
        noteWordsContainer.style.fontSize = settings.noteSize + 'px';
        noteWordsContainer.style.color = settings.noteColor;
        noteWordsContainer.style.lineHeight = settings.noteLineHeight + 'px';
        
        noteXValue.textContent = settings.noteX + 'px';
        noteYValue.textContent = settings.noteY + 'px';
        noteSizeValue.textContent = settings.noteSize + 'px';
        noteLineHeightValue.textContent = settings.noteLineHeight + 'px';
        
        noteX.value = settings.noteX;
        noteY.value = settings.noteY;        noteSize.value = settings.noteSize;
        noteColor.value = settings.noteColor;
        noteLineHeight.value = settings.noteLineHeight;
    }

    function updatePreviewWithCode(code) {
        if (code.length !== 4) return;
        currentCode = code;
        originalWords = wordsList.filter(function(w) { return w.code === code; }).map(function(w) { return w.word; });
        originalWords.sort(function(a, b) { return a.localeCompare(b); });
        currentWords = originalWords.slice();
        
        var firstDigit = parseInt(code[0]);
        letterLists = [];
        for (var pos = 0; pos < firstDigit; pos++) {
            letterLists[pos] = [];
            for (var i = 0; i < originalWords.length; i++) {
                var word = originalWords[i];
                if (word.length > pos && letterLists[pos].indexOf(word[pos]) === -1) {
                    letterLists[pos].push(word[pos]);
                }
            }
            letterLists[pos].sort();
        }
        
        bestListIndex = -1;
        var maxSize = 0;
        for (var i = 0; i < letterLists.length; i++) {
            if (letterLists[i].length > maxSize) {
                maxSize = letterLists[i].length;
                bestListIndex = i;
            }
        }
        bestListLetters = bestListIndex !== -1 ? letterLists[bestListIndex] : [];
        
        indexDisplay.textContent = bestListIndex !== -1 ? (bestListIndex + 1).toString() : '';
        displayWords(currentWords);
        displayLetterButtons(bestListIndex, bestListLetters);
        wordsContainer.classList.remove('hidden');
        lettersContainer.classList.remove('hidden');
    }

    function displayWords(words) {
        wordsContainer.innerHTML = '';
        if (words.length === 0) {
            wordsContainer.innerHTML = '<div class="words-line">Aucun mot</div>';
            return;
        }
        var line = document.createElement('div');
        line.className = 'words-line';        for (var i = 0; i < words.length; i++) {
            var word = words[i];
            var span = document.createElement('span');
            span.className = 'result-word';
            span.textContent = word;
            (function(w) {
                span.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (noteModeActive) {
                        openNotePage(w);
                    } else {
                        window.open('https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(w), '_blank');
                    }
                });
            })(word);
            line.appendChild(span);
            if (i < words.length - 1) line.appendChild(document.createTextNode(' '));
        }
        wordsContainer.appendChild(line);
    }

    function openNotePage(word) {
        noteText.textContent = word;
        notePage.classList.add('visible');
    }

    function displayLetterButtons(index, letters) {
        lettersContainer.innerHTML = '';
        if (letters.length === 0) return;
        for (var i = 0; i < letters.length; i++) {
            var letter = letters[i];
            var span = document.createElement('span');
            span.className = 'letter-btn' + (selectedLetter === letter ? ' selected' : '');
            span.textContent = letter.toUpperCase();
            (function(ltr) {
                span.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (selectedLetter === ltr) {
                        selectedLetter = '';
                        currentWords = originalWords.slice();
                    } else {
                        selectedLetter = ltr;
                        currentWords = originalWords.filter(function(w) { return w[index] === ltr; });
                    }
                    var btns = document.querySelectorAll('.letter-btn');
                    for (var j = 0; j < btns.length; j++) btns[j].classList.remove('selected');
                    if (selectedLetter) span.classList.add('selected');
                    displayWords(currentWords);
                });
            })(letter);            lettersContainer.appendChild(span);
            if (i < letters.length - 1) {
                var spacer = document.createElement('span');
                spacer.innerHTML = '    ';
                lettersContainer.appendChild(spacer);
            }
        }
    }

    function startDragging() { 
        if (customizePage.classList.contains('visible')) {
            customizePage.classList.add('dragging-slider'); 
            resultPage.classList.add('dragging-active');
        }
        if (customizeNotePage.classList.contains('visible')) {
            customizeNotePage.classList.add('dragging-slider');
        }
    }
    function stopDragging() { 
        customizePage.classList.remove('dragging-slider'); 
        resultPage.classList.remove('dragging-active');
        customizeNotePage.classList.remove('dragging-slider');
    }

    var allSliders = [wordsY, wordsSize, wordsLineHeight, lettersY, lettersSize, lettersSpacing, indexY, indexSize, indexX, noteX, noteY, noteSize, noteLineHeight];
    for (var i = 0; i < allSliders.length; i++) {
        if (allSliders[i]) {
            allSliders[i].addEventListener('touchstart', startDragging);
            allSliders[i].addEventListener('touchend', stopDragging);
            allSliders[i].addEventListener('touchcancel', stopDragging);
        }
    }

    var previewBtns = [previewListBtn, previewLettersBtn, previewIndexBtn, previewNoteBtn];
    for (var i = 0; i < previewBtns.length; i++) {
        if (previewBtns[i]) {
            previewBtns[i].addEventListener('touchstart', startDragging);
            previewBtns[i].addEventListener('touchend', stopDragging);
            previewBtns[i].addEventListener('touchcancel', stopDragging);
        }
    }

    function resetToDefault(setting, defaultValue) {
        return function() {
            currentSettings[setting] = defaultValue;
            
            if (setting === 'wordsY') {
                wordsContainer.style.top = defaultValue + 'px';
                wordsYValue.textContent = defaultValue + 'px';
                wordsY.value = defaultValue;            }
            else if (setting === 'wordsSize') {
                wordsContainer.style.fontSize = defaultValue + 'px';
                wordsSizeValue.textContent = defaultValue + 'px';
                wordsSize.value = defaultValue;
            }
            else if (setting === 'wordsLineHeight') {
                wordsContainer.style.lineHeight = defaultValue + 'px';
                wordsLineHeightValue.textContent = defaultValue + 'px';
                wordsLineHeight.value = defaultValue;
            }
            else if (setting === 'lettersY') {
                lettersContainer.style.top = defaultValue + 'px';
                lettersYValue.textContent = defaultValue + 'px';
                lettersY.value = defaultValue;
            }
            else if (setting === 'lettersSize') {
                lettersContainer.style.fontSize = defaultValue + 'px';
                lettersSizeValue.textContent = defaultValue + 'px';
                lettersSize.value = defaultValue;
            }
            else if (setting === 'lettersSpacing') {
                lettersContainer.style.gap = defaultValue + 'px';
                lettersSpacingValue.textContent = defaultValue + 'px';
                lettersSpacing.value = defaultValue;
            }
            else if (setting === 'indexY') {
                indexDisplay.style.top = defaultValue + 'px';
                indexYValue.textContent = defaultValue + 'px';
                indexY.value = defaultValue;
            }
            else if (setting === 'indexSize') {
                indexDisplay.style.fontSize = defaultValue + 'px';
                indexSizeValue.textContent = defaultValue + 'px';
                indexSize.value = defaultValue;
            }
            else if (setting === 'indexX') {
                indexDisplay.style.transform = 'translateX(calc(-50% + ' + defaultValue + 'px))';
                indexXValue.textContent = defaultValue + 'px';
                indexX.value = defaultValue;
            }
        };
    }

    function resetNoteToDefault(setting, defaultValue) {
        return function() {
            currentNoteSettings[setting] = defaultValue;
            
            if (setting === 'noteX') {
                noteWordsContainer.style.transform = 'translateX(calc(-50% + ' + defaultValue + 'px))';                noteXValue.textContent = defaultValue + 'px';
                noteX.value = defaultValue;
            }
            else if (setting === 'noteY') {
                noteWordsContainer.style.top = defaultValue + 'px';
                noteYValue.textContent = defaultValue + 'px';
                noteY.value = defaultValue;
            }
            else if (setting === 'noteSize') {
                noteWordsContainer.style.fontSize = defaultValue + 'px';
                noteSizeValue.textContent = defaultValue + 'px';
                noteSize.value = defaultValue;
            }
            else if (setting === 'noteLineHeight') {
                noteWordsContainer.style.lineHeight = defaultValue + 'px';
                noteLineHeightValue.textContent = defaultValue + 'px';
                noteLineHeight.value = defaultValue;
            }
        };
    }

    wordsYValue.addEventListener('click', resetToDefault('wordsY', defaultSettings.wordsY));
    wordsSizeValue.addEventListener('click', resetToDefault('wordsSize', defaultSettings.wordsSize));
    wordsLineHeightValue.addEventListener('click', resetToDefault('wordsLineHeight', defaultSettings.wordsLineHeight));
    lettersYValue.addEventListener('click', resetToDefault('lettersY', defaultSettings.lettersY));
    lettersSizeValue.addEventListener('click', resetToDefault('lettersSize', defaultSettings.lettersSize));
    lettersSpacingValue.addEventListener('click', resetToDefault('lettersSpacing', defaultSettings.lettersSpacing));
    indexYValue.addEventListener('click', resetToDefault('indexY', defaultSettings.indexY));
    indexSizeValue.addEventListener('click', resetToDefault('indexSize', defaultSettings.indexSize));
    indexXValue.addEventListener('click', resetToDefault('indexX', defaultSettings.indexX));

    noteXValue.addEventListener('click', resetNoteToDefault('noteX', defaultNoteSettings.noteX));
    noteYValue.addEventListener('click', resetNoteToDefault('noteY', defaultNoteSettings.noteY));
    noteSizeValue.addEventListener('click', resetNoteToDefault('noteSize', defaultNoteSettings.noteSize));
    noteLineHeightValue.addEventListener('click', resetNoteToDefault('noteLineHeight', defaultNoteSettings.noteLineHeight));

    wordsY.addEventListener('input', function(e) { currentSettings.wordsY = parseInt(e.target.value); wordsYValue.textContent = currentSettings.wordsY + 'px'; wordsContainer.style.top = currentSettings.wordsY + 'px'; });
    wordsSize.addEventListener('input', function(e) { currentSettings.wordsSize = parseInt(e.target.value); wordsSizeValue.textContent = currentSettings.wordsSize + 'px'; wordsContainer.style.fontSize = currentSettings.wordsSize + 'px'; });
    wordsColor.addEventListener('input', function(e) { currentSettings.wordsColor = e.target.value; wordsContainer.style.color = currentSettings.wordsColor; });
    wordsLineHeight.addEventListener('input', function(e) { currentSettings.wordsLineHeight = parseInt(e.target.value); wordsLineHeightValue.textContent = currentSettings.wordsLineHeight + 'px'; wordsContainer.style.lineHeight = currentSettings.wordsLineHeight + 'px'; });
    lettersY.addEventListener('input', function(e) { currentSettings.lettersY = parseInt(e.target.value); lettersYValue.textContent = currentSettings.lettersY + 'px'; lettersContainer.style.top = currentSettings.lettersY + 'px'; });
    lettersSize.addEventListener('input', function(e) { currentSettings.lettersSize = parseInt(e.target.value); lettersSizeValue.textContent = currentSettings.lettersSize + 'px'; lettersContainer.style.fontSize = currentSettings.lettersSize + 'px'; });
    lettersColor.addEventListener('input', function(e) { currentSettings.lettersColor = e.target.value; lettersContainer.style.color = currentSettings.lettersColor; });
    lettersSpacing.addEventListener('input', function(e) { currentSettings.lettersSpacing = parseInt(e.target.value); lettersSpacingValue.textContent = currentSettings.lettersSpacing + 'px'; lettersContainer.style.gap = currentSettings.lettersSpacing + 'px'; });
    indexY.addEventListener('input', function(e) { currentSettings.indexY = parseInt(e.target.value); indexYValue.textContent = currentSettings.indexY + 'px'; indexDisplay.style.top = currentSettings.indexY + 'px'; });
    indexSize.addEventListener('input', function(e) { currentSettings.indexSize = parseInt(e.target.value); indexSizeValue.textContent = currentSettings.indexSize + 'px'; indexDisplay.style.fontSize = currentSettings.indexSize + 'px'; });
    indexColor.addEventListener('input', function(e) { currentSettings.indexColor = e.target.value; indexDisplay.style.color = currentSettings.indexColor; });
    indexX.addEventListener('input', function(e) { currentSettings.indexX = parseInt(e.target.value); indexXValue.textContent = currentSettings.indexX + 'px'; indexDisplay.style.transform = 'translateX(calc(-50% + ' + currentSettings.indexX + 'px))'; });

    noteX.addEventListener('input', function(e) { currentNoteSettings.noteX = parseInt(e.target.value); noteXValue.textContent = currentNoteSettings.noteX + 'px'; noteWordsContainer.style.transform = 'translateX(calc(-50% + ' + currentNoteSettings.noteX + 'px))'; });    noteY.addEventListener('input', function(e) { currentNoteSettings.noteY = parseInt(e.target.value); noteYValue.textContent = currentNoteSettings.noteY + 'px'; noteWordsContainer.style.top = currentNoteSettings.noteY + 'px'; });
    noteSize.addEventListener('input', function(e) { currentNoteSettings.noteSize = parseInt(e.target.value); noteSizeValue.textContent = currentNoteSettings.noteSize + 'px'; noteWordsContainer.style.fontSize = currentNoteSettings.noteSize + 'px'; });
    noteColor.addEventListener('input', function(e) { currentNoteSettings.noteColor = e.target.value; noteWordsContainer.style.color = currentNoteSettings.noteColor; });
    noteLineHeight.addEventListener('input', function(e) { currentNoteSettings.noteLineHeight = parseInt(e.target.value); noteLineHeightValue.textContent = currentNoteSettings.noteLineHeight + 'px'; noteWordsContainer.style.lineHeight = currentNoteSettings.noteLineHeight + 'px'; });

    testCodeInput.addEventListener('input', function(e) {
        var code = e.target.value.trim();
        if (code.length === 4 && /^\d+$/.test(code)) updatePreviewWithCode(code);
    });

    searchInput.addEventListener('input', function() { enableSearchButton(); codeResult.textContent = ''; codeResult.classList.remove('error'); });

    searchBtn.addEventListener('click', function() {
        if (isSearchDisabled) return;
        var word = searchInput.value.trim();
        if (!word) return;
        var result = searchWord(word);
        if (result) {
            codeResult.textContent = result.code;
            codeResult.classList.remove('error');
            disableSearchButton();
            searchInput.blur();
        } else {
            codeResult.textContent = 'Mot introuvable !';
            codeResult.classList.add('error');
        }
    });

    searchInput.addEventListener('keypress', function(e) { if (e.key === 'Enter' && !isSearchDisabled) searchBtn.click(); });

    btnPerform.addEventListener('click', function() {
        homePage.classList.add('hidden');
        lockPage.classList.add('visible');
        pin = '';
        updateDots();
    });

    btnList.addEventListener('click', function() {
        resetModalToNormal();
        modal.classList.add('visible');
        modalOverlay.classList.add('visible');
    });

    btnSettings.addEventListener('click', function() {
        homePage.classList.add('hidden');
        settingsPage.classList.add('visible');
    });

    modifyNoteBtn.addEventListener('click', function() {
        settingsPage.classList.remove('visible');        customizeNotePage.classList.add('visible');
        currentNoteSettings = loadNoteSettings();
        applyNoteSettings(currentNoteSettings);
    });

    customizeBtn.addEventListener('click', function() {
        settingsPage.classList.remove('visible');
        isPreviewMode = true;
        customizePage.classList.add('visible', 'preview-mode');
        resultPage.classList.add('preview-mode');
        currentSettings = loadCustomSettings();
        updatePreviewWithCode("7131");
        applyCustomSettings(currentSettings);
    });

    customizeBack.addEventListener('click', function() {
        customizePage.classList.remove('visible', 'preview-mode');
        resultPage.classList.remove('preview-mode');
        settingsPage.classList.add('visible');
        isPreviewMode = false;
        currentSettings = loadCustomSettings();
        applyCustomSettings(currentSettings);
    });

    customizeNoteBack.addEventListener('click', function() {
        customizeNotePage.classList.remove('visible', 'preview-mode');
        settingsPage.classList.add('visible');
        currentNoteSettings = loadNoteSettings();
        applyNoteSettings(currentNoteSettings);
    });

    customizeSave.addEventListener('click', function() {
        saveCustomSettings(currentSettings);
        customizePage.classList.remove('visible', 'preview-mode');
        resultPage.classList.remove('preview-mode');
        settingsPage.classList.add('visible');
        isPreviewMode = false;
    });

    // ‚úÖ CORRECTION 1 : Sauvegarde des r√©glages NOTE corrig√©e
    customizeNoteSave.addEventListener('click', function() {
        saveNoteSettings(currentNoteSettings);
        customizeNotePage.classList.remove('visible', 'preview-mode');
        settingsPage.classList.add('visible');
    });

    customizeReset.addEventListener('click', function() {
        currentSettings = JSON.parse(JSON.stringify(defaultSettings));
        applyCustomSettings(currentSettings);
    });
    customizeNoteReset.addEventListener('click', function() {
        currentNoteSettings = JSON.parse(JSON.stringify(defaultNoteSettings));
        applyNoteSettings(currentNoteSettings);
    });

    settingsBack.addEventListener('click', function() {
        settingsPage.classList.remove('visible');
        homePage.classList.remove('hidden');
        previewContainer.classList.remove('visible');
    });

    modalOverlay.addEventListener('click', function() {
        modal.classList.remove('visible');
        modalOverlay.classList.remove('visible');
        searchInput.blur();
        keyboardVisible = false;
        modal.classList.remove('keyboard-open');
        resetModalToNormal();
    });

    function updateDots() {
        for (var i = 0; i < dots.length; i++) {
            if (i < pin.length) dots[i].classList.add('active');
            else dots[i].classList.remove('active');
        }
    }

    function resetModalToNormal() {
        searchInput.value = '';
        codeResult.textContent = '';
        codeResult.classList.remove('error');
        enableSearchButton();
        keyboardVisible = false;
        modal.classList.remove('keyboard-open');
    }

    function animateKey(element) {
        if (!element) return;
        element.classList.add('active');
        setTimeout(function() { element.classList.remove('active'); }, 350);
    }

    for (var i = 0; i < keys.length; i++) {
        keys[i].addEventListener('click', function() {
            animateKey(this);
            if (pin.length < 4) {
                var numberSpan = this.querySelector('.key-number');
                pin += numberSpan ? numberSpan.innerText : this.innerText;
                updateDots();            }
        });
    }

    deleteBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (deleteBtn.classList) deleteBtn.classList.add('active-text');
        setTimeout(function() { if (deleteBtn.classList) deleteBtn.classList.remove('active-text'); }, 350);
        if (pin.length > 0) {
            pin = pin.slice(0, -1);
            updateDots();
        }
    });

    okBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (okBtn.classList) okBtn.classList.add('active-text');
        setTimeout(function() { if (okBtn.classList) okBtn.classList.remove('active-text'); }, 350);
        if (pin.length === 4) {
            currentCode = pin;
            updatePreviewWithCode(pin);
            lockPage.classList.remove('visible');
            resultPage.classList.add('visible');
            pin = '';
            updateDots();
        }
    });

    emergencyBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (emergencyBtn.classList) emergencyBtn.classList.add('active-text');
        setTimeout(function() { if (emergencyBtn.classList) emergencyBtn.classList.remove('active-text'); }, 350);
        lockPage.classList.remove('visible');
        homePage.classList.remove('hidden');
        pin = '';
        updateDots();
    });

    indexDisplay.addEventListener('click', function(e) {
        e.stopPropagation();
        indexClickCount++;
        
        if (indexClickCount === 1) {
            indexClickTimer = setTimeout(function() {
                wordsContainer.classList.toggle('hidden');
                lettersContainer.classList.toggle('hidden');
                indexClickCount = 0;
            }, 300);
        } else if (indexClickCount === 2) {
            clearTimeout(indexClickTimer);            noteModeActive = !noteModeActive;
            if (noteModeActive) {
                indexDisplay.classList.add('note-mode-active');
            } else {
                indexDisplay.classList.remove('note-mode-active');
            }
            indexClickCount = 0;
        }
    });

    notePage.addEventListener('click', function(e) {
        var now = Date.now();
        if (now - noteLastTap < 300 && now - noteLastTap > 0) {
            notePage.classList.remove('visible');
            noteLastTap = 0;
        } else {
            noteLastTap = now;
        }
    });

    resultPage.addEventListener('click', function(e) {
        if (e.target.classList.contains('result-word') || e.target.classList.contains('letter-btn') || e.target === indexDisplay) return;
        var now = Date.now();
        if (now - lastTap < 300 && now - lastTap > 0) {
            resultPage.classList.remove('visible');
            lockPage.classList.add('visible');
            selectedLetter = '';
        }
        lastTap = now;
    });

    function setupImageImport(input, target, storageKey) {
        input.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(event) {
                    currentPreviewData = event.target.result;
                    previewImage.src = currentPreviewData;
                    previewContainer.classList.add('visible');
                    currentPreviewTarget = target === lockPage ? 'bg' : (target === resultPage ? 'img' : 'note');
                };
                reader.readAsDataURL(file);
            }
        });
    }

    try {
        var savedBg = localStorage.getItem('backgroundImage');
        if (savedBg) lockPage.style.backgroundImage = 'url(' + savedBg + ')';        var savedImg = localStorage.getItem('resultImage');
        if (savedImg) resultPage.style.backgroundImage = 'url(' + savedImg + ')';
        var savedNote = localStorage.getItem('noteImage');
        if (savedNote) {
            customizeNotePage.style.backgroundImage = 'url(' + savedNote + ')';
        }
    } catch(e) {}

    setupImageImport(bgFileInput, lockPage, 'backgroundImage');
    setupImageImport(imgFileInput, resultPage, 'resultImage');
    setupImageImport(noteFileInput, customizeNotePage, 'noteImage');
    
    importBgBtn.addEventListener('click', function() { bgFileInput.click(); });
    importImgBtn.addEventListener('click', function() { imgFileInput.click(); });
    importNoteBtn.addEventListener('click', function() { noteFileInput.click(); });

    previewConfirm.addEventListener('click', function() {
        if (currentPreviewTarget === 'bg') {
            lockPage.style.backgroundImage = 'url(' + currentPreviewData + ')';
            try { localStorage.setItem('backgroundImage', currentPreviewData); } catch(e) {}
        } else if (currentPreviewTarget === 'img') {
            resultPage.style.backgroundImage = 'url(' + currentPreviewData + ')';
            try { localStorage.setItem('resultImage', currentPreviewData); } catch(e) {}
        } else if (currentPreviewTarget === 'note') {
            customizeNotePage.style.backgroundImage = 'url(' + currentPreviewData + ')';
            try { localStorage.setItem('noteImage', currentPreviewData); } catch(e) {}
        }
        previewContainer.classList.remove('visible');
        currentPreviewData = '';
    });

    previewCancel.addEventListener('click', function() {
        previewContainer.classList.remove('visible');
        currentPreviewData = '';
    });

    currentSettings = loadCustomSettings();
    applyCustomSettings(currentSettings);
    currentNoteSettings = loadNoteSettings();
    applyNoteSettings(currentNoteSettings);
    updateDots();
    resetModalToNormal();
})();
    </script>
</body>
</html>
