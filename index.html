<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEST - Note Mode (Corrig√©)</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            height: 100vh;
            overflow: hidden;
            color: white;
        }

        /* ANIMATIONS */
        @keyframes scintillement {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700; }
            50% { text-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700; }
        }

        /* PAGE PARAM√àTRES */
        #settings-page {
            position: absolute;
            inset: 0;
            background: black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 20px;
        }

        .settings-title {
            font-size: 48px;
            color: #FFD700;
            margin-bottom: 50px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 4px;
            animation: scintillement 2s ease-in-out infinite;
        }

        .settings-btn {
            width: 320px;
            height: 65px;
            background: #333;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 22px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            transition: background 0.2s, transform 0.1s;
        }

        .settings-btn:active {
            background: #555;
            transform: scale(0.98);
        }

        .preview-container {
            width: 320px;
            margin: 20px 0;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .preview-container.visible {
            display: flex;
        }

        .preview-image {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            border: 3px solid #FFD700;
            margin-bottom: 15px;
        }

        .preview-buttons {
            display: flex;
            gap: 20px;
        }

        .preview-confirm, .preview-cancel {
            width: 120px;
            height: 50px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }

        .preview-confirm {
            background: #4CAF50;
            color: white;
        }

        .preview-cancel {
            background: #f44336;
            color: white;
        }

        .test-btn {
            width: 320px;
            height: 65px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 30px;
        }

        /* PAGE PERSONNALISATION */
        #customize-page {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 20;
            display: none;
            overflow-y: auto;
            padding: 20px;
            color: white;
            transition: background 0.2s ease, backdrop-filter 0.2s ease;
        }

        #customize-page.visible {
            display: block;
        }

        /* Effet de transparence quand on manipule un curseur */
        #customize-page.dragging-slider {
            background: transparent !important;
            backdrop-filter: none !important;
            pointer-events: none;
        }

        #customize-page.dragging-slider .control-group,
        #customize-page.dragging-slider .customize-header,
        #customize-page.dragging-slider .customize-actions {
            opacity: 0 !important;
            transition: opacity 0.1s ease;
            pointer-events: none;
        }

        #customize-page.dragging-slider input[type="range"] {
            opacity: 1 !important;
            position: relative;
            z-index: 9999;
            pointer-events: auto;
        }

        #customize-page.dragging-slider .value-badge {
            opacity: 1 !important;
            position: relative;
            z-index: 9999;
            pointer-events: auto;
            cursor: pointer;
            background: #FFD700;
            color: black;
            font-weight: bold;
        }

        #customize-page.dragging-slider .slider-item {
            position: relative;
            z-index: 9999;
        }

        #result-page.preview-mode.dragging-active {
            opacity: 1 !important;
            z-index: 15;
        }

        .customize-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 20px;
            position: relative;
            z-index: 21;
        }

        .customize-back-btn {
            width: 40px;
            height: 40px;
            background: #333;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .customize-back-btn:active {
            background: #555;
            transform: scale(0.95);
        }

        .customize-title {
            font-size: 32px;
            color: #FFD700;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .control-group {
            background: #222;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #444;
            position: relative;
            z-index: 21;
            transition: opacity 0.2s ease;
        }

        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .control-header h3 {
            color: #FFD700;
            font-size: 22px;
            margin: 0;
        }

        .preview-btn {
            background: #333;
            color: white;
            border: 1px solid #FFD700;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.2s;
        }

        .preview-btn:active {
            background: #444;
        }

        .slider-item {
            margin-bottom: 20px;
        }

        .slider-item label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #ddd;
            font-size: 16px;
        }

        .slider-item input[type="range"] {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            -webkit-appearance: none;
        }

        .slider-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .color-item {
            margin-bottom: 20px;
        }

        .color-item label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
        }

        .color-item input[type="color"] {
            width: 100%;
            height: 45px;
            border: 2px solid #444;
            border-radius: 10px;
            background: #333;
            cursor: pointer;
        }

        .value-badge {
            background: #333;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 14px;
            color: #FFD700;
            border: 1px solid #FFD700;
            cursor: pointer;
            transition: background 0.2s;
        }

        .value-badge:active {
            background: #444;
        }

        .customize-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 30px;
            position: relative;
            z-index: 21;
        }

        .customize-save {
            flex: 1.2;
            height: 55px;
            background: #4CAF50;
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .customize-save:active {
            transform: scale(0.98);
        }

        .customize-reset {
            flex: 1;
            height: 55px;
            background: #f44336;
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }

        .customize-reset:active {
            transform: scale(0.98);
        }

        /* PAGE R√âSULTAT */
        #result-page {
            position: absolute;
            inset: 0;
            z-index: 5;
            display: none;
            background: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=500') no-repeat center center/cover;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        #result-page.visible {
            display: flex;
        }

        .result-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.2);
            z-index: 6;
        }

        /* Liste de mots */
        .words-container {
            position: absolute;
            top: 265px;
            left: 0;
            width: 100%;
            z-index: 7;
            color: white;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .words-line {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .result-word {
            background: transparent;
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: inherit;
            color: inherit;
            cursor: pointer;
            display: inline-block;
            transition: background 0.2s;
        }

        .result-word:active {
            background: rgba(255,255,255,0.2);
        }

        /* Bouton Note (bleu) */
        .note-button {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #1877F2;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
            left: calc(50% + 43px);
            transform: translateX(-50%);
            top: 520px;
        }

        .note-button.active {
            background: #0a5cbf;
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 0 20px #1877F2;
        }

        .note-button:active {
            transform: translateX(-50%) scale(0.95);
        }

        /* Texte Note (sur la page r√©sultat) */
        .note-text {
            position: absolute;
            color: white;
            font-size: 20px;
            z-index: 8;
            text-align: center;
            width: 100%;
            padding: 0 20px;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            top: 265px;
            line-height: 15px;
            display: none;
            white-space: pre-line;
        }

        /* Image Note (plein √©cran) */
        .note-image-overlay {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .note-image-overlay.visible {
            display: flex;
        }

        .note-image-display {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 101;
        }

        /* Bouton Note dans l'overlay (pour l'aper√ßu) */
        .note-button-preview {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #1877F2;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 103;
            left: calc(50% + 43px);
            transform: translateX(-50%);
            top: 520px;
            pointer-events: none;
        }

        .note-image-text {
            position: relative;
            z-index: 102;
            color: white;
            font-size: 24px;
            max-width: 80%;
            text-align: center;
            cursor: text;
            white-space: pre-line;
            line-height: 1.5;
            min-width: 200px;
            outline: none;
            background: transparent;
            border: none;
            padding: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hidden-file-input {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Inputs file -->
    <input type="file" id="note-file-input" class="hidden-file-input" accept="image/*">

    <!-- PAGE PARAM√àTRES -->
    <div id="settings-page">
        <div class="settings-title">PARAM√àTRES</div>
        
        <button class="settings-btn" id="import-note-btn">üì∑ Importer Note</button>
        
        <!-- Zone d'aper√ßu -->
        <div class="preview-container" id="preview-container">
            <img class="preview-image" id="preview-image" src="" alt="Aper√ßu">
            <div class="preview-buttons">
                <button class="preview-confirm" id="preview-confirm">Confirmer</button>
                <button class="preview-cancel" id="preview-cancel">Annuler</button>
            </div>
        </div>

        <button class="settings-btn" id="customize-btn">üé® Personnaliser l'affichage</button>
        <button class="test-btn" id="test-result-btn">‚ñ∂ Tester l'affichage</button>
    </div>

    <!-- PAGE DE PERSONNALISATION -->
    <div id="customize-page">
        <div class="customize-header">
            <button class="customize-back-btn" id="customize-back">‚Üê</button>
            <span class="customize-title">PERSONNALISER</span>
        </div>

        <!-- Section NOTE (Liste) - pour le texte -->
        <div class="control-group">
            <div class="control-header">
                <h3>üìù Note (Liste)</h3>
                <button class="preview-btn" id="preview-note-text-btn">üëÅÔ∏è Aper√ßu</button>
            </div>
            
            <div class="slider-item">
                <label>Position Y <span class="value-badge" id="note-text-y-value" data-default="265">265px</span></label>
                <input type="range" id="note-text-y" min="0" max="800" value="265" step="1">
            </div>

            <div class="slider-item">
                <label>Taille police <span class="value-badge" id="note-text-size-value" data-default="20">20px</span></label>
                <input type="range" id="note-text-size" min="10" max="60" value="20" step="1">
            </div>

            <div class="color-item">
                <label>Couleur</label>
                <input type="color" id="note-text-color" value="#ffffff">
            </div>

            <div class="slider-item">
                <label>Espacement <span class="value-badge" id="note-text-spacing-value" data-default="15">15px</span></label>
                <input type="range" id="note-text-spacing" min="0" max="50" value="15" step="1">
            </div>
        </div>

        <!-- Section NOTE (Bouton) -->
        <div class="control-group">
            <div class="control-header">
                <h3>üîµ Note (Bouton)</h3>
                <button class="preview-btn" id="preview-note-button-btn">üëÅÔ∏è Aper√ßu</button>
            </div>
            
            <div class="slider-item">
                <label>Position Y <span class="value-badge" id="note-button-y-value" data-default="520">520px</span></label>
                <input type="range" id="note-button-y" min="0" max="800" value="520" step="1">
            </div>

            <div class="slider-item">
                <label>Taille <span class="value-badge" id="note-button-size-value" data-default="30">30px</span></label>
                <input type="range" id="note-button-size" min="5" max="80" value="30" step="1">
            </div>

            <div class="slider-item">
                <label>D√©calage X <span class="value-badge" id="note-button-x-value" data-default="43">43px</span></label>
                <input type="range" id="note-button-x" min="-200" max="200" value="43" step="1">
            </div>
        </div>

        <!-- Boutons Sauvegarder et R√©initialiser -->
        <div class="customize-actions">
            <button class="customize-save" id="customize-save">üíæ Sauvegarder</button>
            <button class="customize-reset" id="customize-reset">‚Ü∫ R√©initialiser</button>
        </div>
    </div>

    <!-- PAGE R√âSULTAT -->
    <div id="result-page">
        <div class="result-overlay"></div>
        
        <!-- Liste de mots -->
        <div class="words-container" id="words-container">
            <div class="words-line">
                <span class="result-word" data-word="abeille">Abeille</span>
                <span class="result-word" data-word="abricot">Abricot</span>
                <span class="result-word" data-word="accord√©on">Accord√©on</span>
                <span class="result-word" data-word="agenda">Agenda</span>
                <span class="result-word" data-word="agneau">Agneau</span>
            </div>
        </div>

        <!-- Bouton Note (bleu) -->
        <div class="note-button" id="note-button"></div>

        <!-- Texte Note (cach√© par d√©faut) -->
        <div class="note-text" id="note-text">Aggrafeuse<br>Velot<br>Ilot<br>Orange<br>Nuage</div>
    </div>

    <!-- Overlay image Note -->
    <div class="note-image-overlay" id="note-image-overlay">
        <img class="note-image-display" id="note-image-display" src="" alt="Note">
        <!-- Bouton pour l'aper√ßu (cach√© par d√©faut) -->
        <div class="note-button-preview" id="note-button-preview"></div>
        <div class="note-image-text" id="note-image-text" contenteditable="false">Aggrafeuse<br>Velot<br>Ilot<br>Orange<br>Nuage</div>
    </div>

    <script>
        (function() {
            // ===== √âL√âMENTS =====
            const settingsPage = document.getElementById('settings-page');
            const customizePage = document.getElementById('customize-page');
            const resultPage = document.getElementById('result-page');
            
            // Boutons
            const importNoteBtn = document.getElementById('import-note-btn');
            const customizeBtn = document.getElementById('customize-btn');
            const testResultBtn = document.getElementById('test-result-btn');
            const customizeBack = document.getElementById('customize-back');
            const customizeSave = document.getElementById('customize-save');
            const customizeReset = document.getElementById('customize-reset');
            
            // Boutons preview
            const previewNoteTextBtn = document.getElementById('preview-note-text-btn');
            const previewNoteButtonBtn = document.getElementById('preview-note-button-btn');
            
            // √âl√©ments Note
            const noteButton = document.getElementById('note-button');
            const noteText = document.getElementById('note-text');
            const noteImageOverlay = document.getElementById('note-image-overlay');
            const noteImageDisplay = document.getElementById('note-image-display');
            const noteImageText = document.getElementById('note-image-text');
            const noteButtonPreview = document.getElementById('note-button-preview');
            const wordsContainer = document.getElementById('words-container');
            
            // Inputs personnalisation Note Texte
            const noteTextY = document.getElementById('note-text-y');
            const noteTextSize = document.getElementById('note-text-size');
            const noteTextColor = document.getElementById('note-text-color');
            const noteTextSpacing = document.getElementById('note-text-spacing');
            
            // Inputs personnalisation Note Bouton
            const noteButtonY = document.getElementById('note-button-y');
            const noteButtonSize = document.getElementById('note-button-size');
            const noteButtonX = document.getElementById('note-button-x');
            
            // Badges
            const noteTextYValue = document.getElementById('note-text-y-value');
            const noteTextSizeValue = document.getElementById('note-text-size-value');
            const noteTextSpacingValue = document.getElementById('note-text-spacing-value');
            const noteButtonYValue = document.getElementById('note-button-y-value');
            const noteButtonSizeValue = document.getElementById('note-button-size-value');
            const noteButtonXValue = document.getElementById('note-button-x-value');
            
            // Import
            const noteFileInput = document.getElementById('note-file-input');
            const previewContainer = document.getElementById('preview-container');
            const previewImage = document.getElementById('preview-image');
            const previewConfirm = document.getElementById('preview-confirm');
            const previewCancel = document.getElementById('preview-cancel');

            // ===== DONN√âES =====
            const defaultSettings = {
                // Note Texte
                noteTextY: 265,
                noteTextSize: 20,
                noteTextColor: '#ffffff',
                noteTextSpacing: 15,
                // Note Bouton
                noteButtonY: 520,
                noteButtonSize: 30,
                noteButtonX: 43
            };

            const DEFAULT_NOTE_TEXT = "Aggrafeuse\nVelot\nIlot\nOrange\nNuage";

            let currentSettings = { ...defaultSettings };
            let noteImageData = localStorage.getItem('noteImage') || '';
            let isNoteModeActive = false;
            let currentPreviewTarget = '';

            // ===== FONCTIONS DE DRAGGING =====
            function startDragging() {
                customizePage.classList.add('dragging-slider');
                resultPage.classList.add('dragging-active');
            }

            function stopDragging() {
                customizePage.classList.remove('dragging-slider');
                resultPage.classList.remove('dragging-active');
            }

            // ===== FONCTIONS DE R√âINITIALISATION =====
            function resetToDefault(valueElement, setting, defaultValue) {
                return function() {
                    currentSettings[setting] = defaultValue;
                    
                    // Mettre √† jour l'affichage
                    if (setting === 'noteTextY') {
                        noteText.style.top = defaultValue + 'px';
                        noteImageText.style.top = defaultValue + 'px';
                    }
                    else if (setting === 'noteTextSize') {
                        noteText.style.fontSize = defaultValue + 'px';
                        noteImageText.style.fontSize = defaultValue + 'px';
                    }
                    else if (setting === 'noteTextColor') {
                        noteText.style.color = defaultValue;
                        noteImageText.style.color = defaultValue;
                    }
                    else if (setting === 'noteTextSpacing') {
                        noteText.style.lineHeight = defaultValue + 'px';
                        noteImageText.style.lineHeight = defaultValue + 'px';
                    }
                    else if (setting === 'noteButtonY') {
                        noteButton.style.top = defaultValue + 'px';
                        noteButtonPreview.style.top = defaultValue + 'px';
                    }
                    else if (setting === 'noteButtonSize') {
                        noteButton.style.width = defaultValue + 'px';
                        noteButton.style.height = defaultValue + 'px';
                        noteButtonPreview.style.width = defaultValue + 'px';
                        noteButtonPreview.style.height = defaultValue + 'px';
                    }
                    else if (setting === 'noteButtonX') {
                        noteButton.style.left = `calc(50% + ${defaultValue}px)`;
                        noteButtonPreview.style.left = `calc(50% + ${defaultValue}px)`;
                    }
                    
                    updateDisplayValues(currentSettings);
                    updateSliders(currentSettings);
                };
            }

            // ===== APPLICATION DES R√âGLAGES =====
            function applyCustomSettings(settings) {
                // Appliquer au texte Note (page r√©sultat)
                noteText.style.top = settings.noteTextY + 'px';
                noteText.style.fontSize = settings.noteTextSize + 'px';
                noteText.style.color = settings.noteTextColor;
                noteText.style.lineHeight = settings.noteTextSpacing + 'px';
                
                // Appliquer au texte dans l'overlay (image Note)
                noteImageText.style.top = settings.noteTextY + 'px';
                noteImageText.style.fontSize = settings.noteTextSize + 'px';
                noteImageText.style.color = settings.noteTextColor;
                noteImageText.style.lineHeight = settings.noteTextSpacing + 'px';
                
                // Appliquer au bouton Note (page r√©sultat)
                noteButton.style.top = settings.noteButtonY + 'px';
                noteButton.style.width = settings.noteButtonSize + 'px';
                noteButton.style.height = settings.noteButtonSize + 'px';
                noteButton.style.left = `calc(50% + ${settings.noteButtonX}px)`;
                
                // Appliquer au bouton preview (dans l'overlay)
                noteButtonPreview.style.top = settings.noteButtonY + 'px';
                noteButtonPreview.style.width = settings.noteButtonSize + 'px';
                noteButtonPreview.style.height = settings.noteButtonSize + 'px';
                noteButtonPreview.style.left = `calc(50% + ${settings.noteButtonX}px)`;

                // Mettre √† jour les valeurs affich√©es
                updateDisplayValues(settings);
            }

            function updateDisplayValues(settings) {
                noteTextYValue.textContent = settings.noteTextY + 'px';
                noteTextSizeValue.textContent = settings.noteTextSize + 'px';
                noteTextSpacingValue.textContent = settings.noteTextSpacing + 'px';
                noteButtonYValue.textContent = settings.noteButtonY + 'px';
                noteButtonSizeValue.textContent = settings.noteButtonSize + 'px';
                noteButtonXValue.textContent = settings.noteButtonX + 'px';
            }

            function updateSliders(settings) {
                noteTextY.value = settings.noteTextY;
                noteTextSize.value = settings.noteTextSize;
                noteTextColor.value = settings.noteTextColor;
                noteTextSpacing.value = settings.noteTextSpacing;
                noteButtonY.value = settings.noteButtonY;
                noteButtonSize.value = settings.noteButtonSize;
                noteButtonX.value = settings.noteButtonX;
            }

            function loadCustomSettings() {
                const saved = localStorage.getItem('noteSettings');
                if (saved) {
                    currentSettings = JSON.parse(saved);
                } else {
                    currentSettings = { ...defaultSettings };
                }
                applyCustomSettings(currentSettings);
                updateSliders(currentSettings);
            }

            function saveCustomSettings() {
                localStorage.setItem('noteSettings', JSON.stringify(currentSettings));
            }

            // Fonction pour fermer l'overlay et d√©sactiver le mode
            function closeNoteOverlayAndDeactivate() {
                noteImageOverlay.classList.remove('visible');
                // D√©sactiver le mode bleu
                isNoteModeActive = false;
                noteButton.classList.remove('active');
                // Remettre le texte par d√©faut
                noteImageText.innerHTML = DEFAULT_NOTE_TEXT.replace(/\n/g, '<br>');
                noteImageText.setAttribute('contenteditable', 'false');
                // Cacher le bouton preview
                noteButtonPreview.style.display = 'none';
            }

            // ===== √âV√âNEMENTS CURSEURS AVEC DRAGGING =====
            const allSliders = [
                noteTextY, noteTextSize, noteTextSpacing,
                noteButtonY, noteButtonSize, noteButtonX
            ];

            allSliders.forEach(slider => {
                if (slider) {
                    slider.addEventListener('touchstart', startDragging);
                    slider.addEventListener('touchend', stopDragging);
                    slider.addEventListener('touchcancel', stopDragging);
                }
            });

            // ===== √âV√âNEMENTS CURSEURS =====
            noteTextY.addEventListener('input', (e) => {
                currentSettings.noteTextY = parseInt(e.target.value);
                noteTextYValue.textContent = currentSettings.noteTextY + 'px';
                noteText.style.top = currentSettings.noteTextY + 'px';
                noteImageText.style.top = currentSettings.noteTextY + 'px';
            });

            noteTextSize.addEventListener('input', (e) => {
                currentSettings.noteTextSize = parseInt(e.target.value);
                noteTextSizeValue.textContent = currentSettings.noteTextSize + 'px';
                noteText.style.fontSize = currentSettings.noteTextSize + 'px';
                noteImageText.style.fontSize = currentSettings.noteTextSize + 'px';
            });

            noteTextColor.addEventListener('input', (e) => {
                currentSettings.noteTextColor = e.target.value;
                noteText.style.color = currentSettings.noteTextColor;
                noteImageText.style.color = currentSettings.noteTextColor;
            });

            noteTextSpacing.addEventListener('input', (e) => {
                currentSettings.noteTextSpacing = parseInt(e.target.value);
                noteTextSpacingValue.textContent = currentSettings.noteTextSpacing + 'px';
                noteText.style.lineHeight = currentSettings.noteTextSpacing + 'px';
                noteImageText.style.lineHeight = currentSettings.noteTextSpacing + 'px';
            });

            noteButtonY.addEventListener('input', (e) => {
                currentSettings.noteButtonY = parseInt(e.target.value);
                noteButtonYValue.textContent = currentSettings.noteButtonY + 'px';
                noteButton.style.top = currentSettings.noteButtonY + 'px';
                noteButtonPreview.style.top = currentSettings.noteButtonY + 'px';
            });

            noteButtonSize.addEventListener('input', (e) => {
                currentSettings.noteButtonSize = parseInt(e.target.value);
                noteButtonSizeValue.textContent = currentSettings.noteButtonSize + 'px';
                noteButton.style.width = currentSettings.noteButtonSize + 'px';
                noteButton.style.height = currentSettings.noteButtonSize + 'px';
                noteButtonPreview.style.width = currentSettings.noteButtonSize + 'px';
                noteButtonPreview.style.height = currentSettings.noteButtonSize + 'px';
            });

            noteButtonX.addEventListener('input', (e) => {
                currentSettings.noteButtonX = parseInt(e.target.value);
                noteButtonXValue.textContent = currentSettings.noteButtonX + 'px';
                noteButton.style.left = `calc(50% + ${currentSettings.noteButtonX}px)`;
                noteButtonPreview.style.left = `calc(50% + ${currentSettings.noteButtonX}px)`;
            });

            // ===== R√âINITIALISATION PAR BADGE =====
            noteTextYValue.addEventListener('click', resetToDefault(noteTextYValue, 'noteTextY', defaultSettings.noteTextY));
            noteTextSizeValue.addEventListener('click', resetToDefault(noteTextSizeValue, 'noteTextSize', defaultSettings.noteTextSize));
            noteTextSpacingValue.addEventListener('click', resetToDefault(noteTextSpacingValue, 'noteTextSpacing', defaultSettings.noteTextSpacing));
            noteButtonYValue.addEventListener('click', resetToDefault(noteButtonYValue, 'noteButtonY', defaultSettings.noteButtonY));
            noteButtonSizeValue.addEventListener('click', resetToDefault(noteButtonSizeValue, 'noteButtonSize', defaultSettings.noteButtonSize));
            noteButtonXValue.addEventListener('click', resetToDefault(noteButtonXValue, 'noteButtonX', defaultSettings.noteButtonX));

            // ===== IMPORT IMAGE NOTE =====
            importNoteBtn.addEventListener('click', () => {
                noteFileInput.click();
            });

            noteFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        previewImage.src = event.target.result;
                        previewContainer.classList.add('visible');
                        currentPreviewTarget = 'note';
                    };
                    reader.readAsDataURL(file);
                }
            });

            previewConfirm.addEventListener('click', () => {
                if (currentPreviewTarget === 'note') {
                    noteImageData = previewImage.src;
                    localStorage.setItem('noteImage', noteImageData);
                }
                previewContainer.classList.remove('visible');
                previewImage.src = '';
                noteFileInput.value = '';
            });

            previewCancel.addEventListener('click', () => {
                previewContainer.classList.remove('visible');
                previewImage.src = '';
                noteFileInput.value = '';
            });

            // ===== BOUTON NOTE (mode activation) =====
            noteButton.addEventListener('click', () => {
                isNoteModeActive = !isNoteModeActive;
                noteButton.classList.toggle('active', isNoteModeActive);
            });

            // ===== CLIC SUR UN MOT =====
            wordsContainer.addEventListener('click', (e) => {
                const wordElement = e.target.closest('.result-word');
                if (!wordElement) return;

                if (isNoteModeActive && noteImageData) {
                    // Mode Note activ√© : afficher l'image Note avec le texte par d√©faut
                    noteImageDisplay.src = noteImageData;
                    noteImageText.innerHTML = DEFAULT_NOTE_TEXT.replace(/\n/g, '<br>');
                    noteImageText.setAttribute('contenteditable', 'false');
                    noteButtonPreview.style.display = 'none'; // Cacher le bouton preview
                    noteImageOverlay.classList.add('visible');
                } else {
                    // Mode normal : recherche Google Images
                    window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(wordElement.textContent)}`, '_blank');
                }
            });

            // ===== GESTION DE L'OVERLAY =====
            // Double-clic pour fermer et d√©sactiver
            noteImageOverlay.addEventListener('dblclick', (e) => {
                e.preventDefault();
                closeNoteOverlayAndDeactivate();
            });

            // Simple clic sur le texte pour l'√©diter
            noteImageText.addEventListener('click', (e) => {
                e.stopPropagation();
                noteImageText.setAttribute('contenteditable', 'true');
                noteImageText.focus();
            });

            // Perte de focus = sortir du mode √©dition
            noteImageText.addEventListener('blur', () => {
                noteImageText.setAttribute('contenteditable', 'false');
            });

            // Emp√™cher la propagation des clics sur le texte pour ne pas fermer
            noteImageText.addEventListener('dblclick', (e) => {
                e.stopPropagation();
            });

            // ===== BOUTONS PREVIEW =====
            function showPreview(targetType) {
                if (targetType === 'note-text' && noteImageData) {
                    // Aper√ßu Note (Liste) : image NOTE + texte
                    noteImageDisplay.src = noteImageData;
                    noteImageText.innerHTML = DEFAULT_NOTE_TEXT.replace(/\n/g, '<br>');
                    noteImageText.setAttribute('contenteditable', 'false');
                    noteButtonPreview.style.display = 'none'; // Cacher le bouton
                    noteImageOverlay.classList.add('visible');
                } else if (targetType === 'note-button') {
                    // Aper√ßu Note (Bouton) : image BACKGROUND + bouton
                    const bgImage = window.getComputedStyle(resultPage).backgroundImage;
                    if (bgImage && bgImage !== 'none') {
                        noteImageDisplay.src = bgImage.slice(5, -2);
                        noteImageText.innerHTML = ''; // Pas de texte
                        noteImageText.setAttribute('contenteditable', 'false');
                        noteButtonPreview.style.display = 'block'; // Afficher le bouton
                        noteImageOverlay.classList.add('visible');
                    }
                }
            }

            function hidePreview() {
                noteImageOverlay.classList.remove('visible');
                noteButtonPreview.style.display = 'none';
            }

            // Gestion des √©v√©nements pour les boutons preview
            function setupPreviewButton(btn, targetType) {
                // Pour mobile (touch)
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    showPreview(targetType);
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    hidePreview();
                });
                
                btn.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    hidePreview();
                });
                
                // Pour desktop (souris)
                btn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    showPreview(targetType);
                });
                
                btn.addEventListener('mouseup', (e) => {
                    e.preventDefault();
                    hidePreview();
                });
                
                btn.addEventListener('mouseleave', (e) => {
                    hidePreview();
                });
            }

            setupPreviewButton(previewNoteTextBtn, 'note-text');
            setupPreviewButton(previewNoteButtonBtn, 'note-button');

            // ===== NAVIGATION =====
            customizeBtn.addEventListener('click', () => {
                settingsPage.style.display = 'none';
                customizePage.classList.add('visible');
                loadCustomSettings();
            });

            customizeBack.addEventListener('click', () => {
                customizePage.classList.remove('visible');
                settingsPage.style.display = 'flex';
            });

            testResultBtn.addEventListener('click', () => {
                settingsPage.style.display = 'none';
                resultPage.classList.add('visible');
                loadCustomSettings();
                // Cacher le texte note par d√©faut
                noteText.style.display = 'none';
            });

            customizeSave.addEventListener('click', () => {
                saveCustomSettings();
                customizePage.classList.remove('visible');
                settingsPage.style.display = 'flex';
            });

            customizeReset.addEventListener('click', () => {
                currentSettings = { ...defaultSettings };
                applyCustomSettings(currentSettings);
                updateSliders(currentSettings);
            });

            // ===== INIT =====
            // Charger l'image Note si elle existe
            if (noteImageData) {
                previewImage.src = noteImageData;
            }
            
            // Appliquer les param√®tres par d√©faut
            applyCustomSettings(defaultSettings);
            updateSliders(defaultSettings);
            
            // Initialiser le texte Note
            noteText.innerHTML = DEFAULT_NOTE_TEXT.replace(/\n/g, '<br>');
            noteImageText.innerHTML = DEFAULT_NOTE_TEXT.replace(/\n/g, '<br>');
            noteButtonPreview.style.display = 'none';
        })();
    </script>
</body>
</html>
